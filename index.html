<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>活動記録</title>
  <style>
    .activity-item {
      margin-bottom: 10px;
    }
    .activity-item span {
      margin-right: 10px;
    }
    .update-button,
    .delete-button {
      margin-left: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>活動記録</h1>
  <form id="activity-form">
    <label for="activity-input">活動名:</label>
    <input type="text" id="activity-input" required>
    <label for="datetime-input">時刻:</label>
    <input type="datetime-local" id="datetime-input" required>
    <button type="submit">追加</button>
  </form>
  <div id="activity-list"></div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      var activityForm = document.getElementById("activity-form");
      var activityInput = document.getElementById("activity-input");
      var datetimeInput = document.getElementById("datetime-input");
      var activityList = document.getElementById("activity-list");

      activityForm.addEventListener("submit", function(event) {
        event.preventDefault();
        var activity = {
          name: activityInput.value,
          time: new Date(datetimeInput.value).getTime()
        };
        addActivity(activity);
        activityInput.value = "";
        datetimeInput.value = "";
      });

      function addActivity(activity) {
        var activities = getActivitiesFromLocalStorage();
        activities.push(activity);
        saveActivitiesToLocalStorage(activities);
        displayActivities();
      }

      function updateActivity(index) {
        var activities = getActivitiesFromLocalStorage();
        activities[index].time = Date.now();
        saveActivitiesToLocalStorage(activities);
        displayActivities();
      }

      function deleteActivity(index) {
        var activities = getActivitiesFromLocalStorage();
        activities.splice(index, 1);
        saveActivitiesToLocalStorage(activities);
        displayActivities();
      }

      function getActivitiesFromLocalStorage() {
        var activities = localStorage.getItem("activities");
        return activities ? JSON.parse(activities) : [];
      }

      function saveActivitiesToLocalStorage(activities) {
        localStorage.setItem("activities", JSON.stringify(activities));
      }

      function displayActivities() {
        var activities = getActivitiesFromLocalStorage();
        activityList.innerHTML = "";

        for (var i = 0; i < activities.length; i++) {
          var activity = activities[i];
          var activityItem = document.createElement("div");
          activityItem.classList.add("activity-item");

          var activityName = document.createElement("span");
          activityName.textContent = activity.name;

          var activityTime = document.createElement("span");
          activityTime.textContent = new Date(activity.time).toLocaleString("ja-JP");

          var elapsedTimeDisplay = document.createElement("span");
          elapsedTimeDisplay.classList.add("elapsed-time");

          var updateButton = document.createElement("button");
          updateButton.classList.add("update-button");
          updateButton.dataset.index = i;
          updateButton.textContent = "開始時刻更新";

          var deleteButton = document.createElement("button");
          deleteButton.classList.add("delete-button");
          deleteButton.dataset.index = i;
          deleteButton.textContent = "削除";

          activityItem.appendChild(activityName);
          activityItem.appendChild(activityTime);
          activityItem.appendChild(elapsedTimeDisplay);
          activityItem.appendChild(updateButton);
          activityItem.appendChild(deleteButton);
          activityList.appendChild(activityItem);

          updateButton.addEventListener("click", function(event) {
            var index = parseInt(event.target.dataset.index);
            updateActivity(index);
          });

          deleteButton.addEventListener("click", function(event) {
            var index = parseInt(event.target.dataset.index);
            deleteActivity(index);
          });
        }

        startElapsedTimeDisplay();
      }

      function startElapsedTimeDisplay() {
        var elapsedTimeElements = document.getElementsByClassName("elapsed-time");
        var intervalId = setInterval(function() {
          var now = Date.now();

          for (var i = 0; i < elapsedTimeElements.length; i++) {
            var activity = getActivitiesFromLocalStorage()[i];
            var startTime = activity.time;
            var elapsedTime = formatElapsedTime(now - startTime);
            elapsedTimeElements[i].textContent = elapsedTime;
          }
        }, 1000);
      }

      function formatElapsedTime(elapsedTime) {
        var seconds = Math.floor(elapsedTime / 1000) % 60;
        var minutes = Math.floor(elapsedTime / 1000 / 60) % 60;
        var hours = Math.floor(elapsedTime / 1000 / 60 / 60) % 24;
        var days = Math.floor(elapsedTime / 1000 / 60 / 60 / 24);

        return (
          (days > 0 ? days + "日 " : "") +
          (hours > 0 ? hours + "時間 " : "") +
          (minutes > 0 ? minutes + "分 " : "") +
          seconds + "秒"
        );
      }

      displayActivities();
    });
  </script>
</body>
</html>
